# CI/CD Pipeline for prompt-pulse-tui (Rust ratatui dashboard)
# Triggered from root .gitlab-ci.yml via local include.
stages:
  - lint
  - test
  - build
  - cache

variables:
  ATTIC_SERVER: "https://nix-cache.fuzzy-dev.tinyland.dev"
  ATTIC_CACHE: "prompt-pulse"
  ATTIC_PUBLIC_KEY: "tinyland-lab:wX4VELFLU2s+MwmbenLd6YPz79mbO1+XE4YzZl5WqBc="
  CARGO_HOME: ${CI_PROJECT_DIR}/cmd/prompt-pulse-tui/.cargo-cache

# =============================================================================
# Reusable Templates
# =============================================================================

.rust-base:
  image: rust:1.83-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq pkg-config > /dev/null
    - rustup component add clippy rustfmt
  cache:
    key: "rust-tui-${CI_COMMIT_REF_SLUG}"
    paths:
      - cmd/prompt-pulse-tui/.cargo-cache/
      - cmd/prompt-pulse-tui/target/
    policy: pull-push

.tui-changes-rule:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH
      changes:
        - cmd/prompt-pulse-tui/**/*
      when: always
    - when: never

# =============================================================================
# Lint Stage
# =============================================================================

tui:lint:clippy:
  stage: lint
  extends:
    - .rust-base
    - .tui-changes-rule
  script:
    - cd cmd/prompt-pulse-tui
    - cargo clippy --all-targets -- -D warnings
  tags:
    - docker

tui:lint:fmt:
  stage: lint
  extends:
    - .rust-base
    - .tui-changes-rule
  script:
    - cd cmd/prompt-pulse-tui
    - cargo fmt --check
  tags:
    - docker

# =============================================================================
# Test Stage
# =============================================================================

tui:test:unit:
  stage: test
  extends:
    - .rust-base
    - .tui-changes-rule
  needs:
    - job: tui:lint:clippy
      optional: true
      artifacts: false
    - job: tui:lint:fmt
      optional: true
      artifacts: false
  script:
    - cd cmd/prompt-pulse-tui
    - cargo test --all-targets
  tags:
    - docker

# =============================================================================
# Build Stage - Nix flake builds
# =============================================================================

.nix_tui_build_base:
  image: nixos/nix:2.24.9
  stage: build
  timeout: 20 minutes
  variables:
    NIX_CONFIG: |
      experimental-features = nix-command flakes
      extra-substituters = ${ATTIC_SERVER}/${ATTIC_CACHE} ${ATTIC_SERVER}/main https://cache.nixos.org
      extra-trusted-public-keys = ${ATTIC_PUBLIC_KEY} main:NKRk1XYo/dfd9fcDqgotUJg2DTDHWp5ny+Ba7WzRjgE= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      connect-timeout = 5
      fallback = true
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - cmd/prompt-pulse-tui/**/*
      when: always
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
      when: always
    - when: never

tui:build:x86_64-linux:
  extends: .nix_tui_build_base
  tags: [tinyland, nix, shell, x86_64-linux]
  script:
    - nix build .#packages.x86_64-linux.prompt-pulse-tui -o result-tui-x86_64-linux --print-build-logs
    - result-tui-x86_64-linux/bin/prompt-pulse-tui --version || true
  artifacts:
    paths: [result-tui-x86_64-linux]
    expire_in: 1 day

tui:build:aarch64-darwin:
  extends: .nix_tui_build_base
  tags: [tinyland, darwin-native]
  script:
    - nix build .#packages.aarch64-darwin.prompt-pulse-tui -o result-tui-aarch64-darwin --print-build-logs
    - result-tui-aarch64-darwin/bin/prompt-pulse-tui --version || true
  artifacts:
    paths: [result-tui-aarch64-darwin]
    expire_in: 1 day

# =============================================================================
# Cache Stage (Attic/Nix)
# =============================================================================

tui:cache:attic:
  image: nixos/nix:2.24.9
  stage: cache
  tags: [tinyland, docker]
  timeout: 10 minutes
  variables:
    NIX_CONFIG: "experimental-features = nix-command flakes"
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - |
      if [ -n "$ATTIC_TOKEN" ]; then
        nix profile install nixpkgs#attic-client 2>/dev/null || true
        mkdir -p ~/.config/attic
        cat > ~/.config/attic/config.toml << EOF
      [servers.default]
      endpoint = "${ATTIC_SERVER}"
      token = "${ATTIC_TOKEN}"
      EOF
      fi
  script:
    - |
      if [ -z "$ATTIC_TOKEN" ]; then
        echo "ATTIC_TOKEN not set, skipping"
        exit 0
      fi
      for result in result-tui-*; do
        [ -e "$result" ] && attic push "${ATTIC_CACHE}" "$result" --jobs 4 || true
      done
  needs:
    - job: tui:build:x86_64-linux
      optional: true
      artifacts: true
    - job: tui:build:aarch64-darwin
      optional: true
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - cmd/prompt-pulse-tui/**/*
      when: on_success
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/
      when: on_success
    - when: never
  allow_failure: true
